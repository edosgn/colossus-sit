<?php

namespace JHWEB\FinancieroBundle\Repository;

/**
 * FroReporteIngresosRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class FroReporteIngresosRepository extends \Doctrine\ORM\EntityRepository
{
    public function findTramitesByFecha($params) {
        
        $em = $this->getEntityManager();

        $fechaInicio = new \Datetime($params->fechaDesde);
        $fechaFin = new \Datetime($params->fechaHasta);
        $organismoTransito = $em->getRepository('JHWEBConfigBundle:CfgOrganismoTransito')->find($params->idOrganismoTransito);
        /* $tipoRecaudo= $em->getRepository('JHWEBFinancieroBundle:FroCfgTipoRecaudo')->find($params->idTipoRecaudo); */

        /* var_dump($organismoTransito);
        die(); */
        
        /* $dql = "SELECT fr
            FROM JHWEBFinancieroBundle:FroRecaudo fr, 
            JHWEBFinancieroBundle:FroTramite ft, 
            JHWEBConfigBundle:CfgOrganismoTransito ot, 
            JHWEBFinancieroBundle:FroFactura ff, 
            JHWEBFinancieroBundle:FroTrtePrecio ftp
            WHERE fr.fecha BETWEEN :fechaInicio AND :fechaFin
            AND ff.organismoTransito = :organismoTransito
            AND ff.tipoRecaudo = :tipoRecaudo
            AND fr.froFactura = ff.id"; */
        
        $dql = "SELECT ftp
        FROM JHWEBFinancieroBundle: FroTrtePrecio ftp,
        JHWEBFinancieroBundle: FroFactura ff,
        JHWEBConfigBundle: CfgOrganismoTransito ot
        WHERE ot.id = :organismoTransito";

        /* if(ff.estado == 'PAGADA'){
            $condicion .= " AND ff.fechaPago BETWEEN " . $fechaInicioDatetime . " AND $fechaFinDatetime";
        } else {
            $condicion .= " AND ff.fechaCreacion BETWEEN " . $fechaInicioDatetime . " AND $fechaFinDatetime";
        }

        if ($condicion) {
            $dql .= $condicion;
        } */

        $consulta = $em->createQuery($dql);

        $consulta->setParameters(array(
            'fechaInicio' => $fechaInicio,
            'fechaFin' => $fechaFin,
            'organismoTransito' => $organismoTransito,
        ));
        /* 'tipoRecaudo' => $tipoRecaudo, */

        return $consulta->getResult();
    }
}
