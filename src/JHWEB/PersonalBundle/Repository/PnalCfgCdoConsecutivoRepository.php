<?php

namespace JHWEB\PersonalBundle\Repository;

/**
 * PnalCfgCdoConsecutivoRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PnalCfgCdoConsecutivoRepository extends \Doctrine\ORM\EntityRepository
{
    //Obtiene el maximo consecutivo disponible segÃºn la sede operativa
    public function getLastByFuncionario($idFuncionario)
    {
        $em = $this->getEntityManager();

        $dql = "SELECT MAX(c.numero) AS numero, c.id
            FROM JHWEBPersonalBundle:PnalCfgCdoConsecutivo c
            WHERE c.funcionario = :idFuncionario
            AND c.estado = :estado
            GROUP BY c.funcionario";
        $consulta = $em->createQuery($dql);

        $consulta->setParameters(array(
            'idFuncionario' => $idFuncionario,
            'estado' => 'ASIGNADO',
        ));

        return $consulta->getOneOrNullResult();
    }

    //Obtiene la lista de funcionarios asignados por cargo
    public function getByFuncionario($params){   
        $em = $this->getEntityManager();

    	$dql = "SELECT pc
        FROM JHWEBPersonalBundle:PnalCfgCdoConsecutivo pc,
        JHWEBPersonalBundle:PnalFuncionario f, 
        JHWEBUsuarioBundle:UserCiudadano c,
        UsuarioBundle:Usuario u
        WHERE pc.funcionario = f.id
        AND u.id = c.usuario
        AND c.id = f.ciudadano
        AND (c.primerNombre = :parametro 
        OR c.segundoNombre = :parametro 
        OR c.primerApellido = :parametro 
        OR c.segundoApellido = :parametro 
        OR f.numeroPlaca = :parametro)";

        $consulta = $em->createQuery($dql);
        $consulta->setParameters(array(
            'parametro' => $params->parametro,
        ));


        return $consulta->getResult();
    }
}
