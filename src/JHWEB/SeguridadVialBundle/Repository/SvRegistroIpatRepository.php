<?php

namespace JHWEB\SeguridadVialBundle\Repository;

use JHWEB\SeguridadVialBundle\Entity\SvRegistroIpat;

/**
 * SvRegistroIpatRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SvRegistroIpatRepository extends \Doctrine\ORM\EntityRepository
{

    public function getIpatByRango($params) {
        $em = $this->getEntityManager();
        $horaInicioDatetime = $params->datos->horaInicio;
        $horaFinDatetime = $params->datos->horaFin;
        $fechaInicioDatetime = new \Datetime($params->datos->fechaInicio);
        $fechaFinDatetime = new \Datetime($params->datos->fechaFin);
        
        if ($params->datos->idGravedad) {
            $gravedad = $em->getRepository('AppBundle:CfgGravedad')->findBy(
                array(
                    'nombre' => $params->datos->idGravedad,
                    )
                );
            }
        if ($params->datos->idTipoVictima) {
            $tipoVictima = $em->getRepository('JHWEBSeguridadVialBundle:SvCfgTipoVictima')->findBy(
                array(
                    'nombre' => $params->datos->idTipoVictima,
                )
            );
        }
        if ($params->datos->idMunicipio) {
            $municipio = $em->getRepository('AppBundle:Municipio')->find($params->datos->idMunicipio);
        }
        $municipioNombre = $municipio->getNombre();

        if ($params->datos->idGenero) {
            $genero = $em->getRepository('AppBundle:Genero')->find($params->datos->idGenero);
        }
        $sexoConductor = $genero->getSigla();

        if ($params->datos->idClase) {
            $clase = $em->getRepository('AppBundle:Clase')->find($params->datos->idClase);
        }
        $claseNombre = $clase->getNombre();

        if ($params->datos->idClaseAccidente) {
            $claseAccidente = $em->getRepository('AppBundle:CfgClaseAccidente')->findBy(
                array(
                    'nombre' => $params->datos->idClaseAccidente,
                )
            );
        }
        if ($params->datos->idChoqueCon) {
            $choqueCon = $em->getRepository('AppBundle:CfgChoqueCon')->findBy(
                array(
                    'nombre' => $params->datos->idChoqueCon,
                )
            );
        }
        if ($params->datos->idObjetoFijo) {
            $objetoFijo = $em->getRepository('AppBundle:CfgObjetoFijo')->find($params->datos->idObjetoFijo);
        }

        $edadInicioConductor = intval($params->datos->idGrupoEdad);
        $edadFinConductor = $edadInicioConductor + 4;
        $diaAccidente = $params->datos->idDiaSemana;
        
        $ipat = new SvRegistroIpat();
        foreach($params->file as $key => $dato) {
            $ipat -> setFechaAccidente(new \Datetime($dato[2]));
            $ipat -> setHoraAccidente(new \Datetime($dato[3]));
            $ipat -> setDiaAccidente($dato[4]);
            $gravedadFile = $em->getRepository('AppBundle:CfgGravedad')->findOneBy(array('nombre' => $dato[11]));
            $ipat -> setGravedad($gravedadFile);
            $tipoVictimaFile = $em->getRepository('JHWEBSeguridadVialBundle:SvCfgTipoVictima')->findOneBy(array('nombre' => $dato[13]));
            $ipat -> setTipoVictima($tipoVictimaFile->getId());
            $ipat -> setCiudadResidenciaConductor($dato[0]);
            $sexoConductorFile = $em->getRepository('AppBundle:Genero')->findOneBy(array('nombre' => $dato[6]));
            $ipat -> setSexoConductor($sexoConductorFile->getSigla());
            $ipat -> setEdadConductor($dato[10]);
            $claseAccidenteFile = $em->getRepository('AppBundle:CfgClaseAccidente')->findOneBy(array('nombre' => $dato[12]));
            $ipat -> setClaseAccidente($claseAccidenteFile->getId());
            
            if($ipat->fechaAccidente >= $fechaInicioDatetime && $ipat->fechaAccidente >= $fechaFinDatetime) {
                
            }
        }

        $dql = "SELECT ri
            FROM JHWEBSeguridadVialBundle:SvRegistroIpat ri
            WHERE ri.fechaAccidente BETWEEN :fechaInicioDatetime AND :fechaFinDatetime
            AND ri.diaAccidente = :diaAccidente
            AND ri.horaAccidente BETWEEN :horaInicioDatetime AND :horaFinDatetime
            AND ri.gravedad = :gravedad
            AND ri.tipoVictima = :tipoVictima
            AND ri.ciudadResidenciaConductor = :municipioNombre
            AND ri.sexoConductor = :sexoConductor
            AND ri.sexoVictima = :sexoConductor
            AND ri.edadConductor BETWEEN :edadInicioConductor AND :edadFinConductor
            AND ri.edadVictima BETWEEN :edadInicioConductor AND :edadFinConductor
            AND ri.clase = :claseNombre
            AND ri.claseAccidente = :claseAccidente
            AND ri.choqueCon = :choqueCon
            AND ri.objetoFijo = :objetoFijo";
        $consulta = $em->createQuery($dql);

        $consulta->setParameters(array(
            'fechaInicioDatetime' => $fechaInicioDatetime,
            'fechaFinDatetime' => $fechaFinDatetime,
            'diaAccidente' => $diaAccidente,
            'horaInicioDatetime' => $horaInicioDatetime,
            'horaFinDatetime' => $horaFinDatetime,
            'gravedad' => $gravedad,
            'tipoVictima' => $tipoVictima,
            'municipioNombre' => $municipioNombre,
            'sexoConductor' => $sexoConductor,
            'edadInicioConductor' => $edadInicioConductor,
            'edadFinConductor' => $edadFinConductor,
            'claseNombre' => $claseNombre,
            'claseAccidente' => $claseAccidente,
            'choqueCon' => $choqueCon,
            'objetoFijo' => $objetoFijo,
        ));

        return $consulta->getResult();
    }
}
